<!DOCTYPE html>
<html>
<head>
<style>
body{background:#d71f2e;}
#container{width:854px;height:504px;background-image:url('images/bg1.png');margin:0 auto;margin-top:-252px;top:50%;position:absolute;left:0px;right:0px;}
#namelist li{list-style:none;height:36px;background:url('images/user.png') no-repeat 0 11px;margin:0px;padding:0px;float:left;line-height:37px;text-indent:1.5em;color:#cc9900;font-weight:bold;}
#arrow{position:absolute;left:181px;top:104px;}
#namelist ul{padding:0px;margin:0px;position:absolute;}
#namelist{width:120px;position:absolute;right:55px;top:124px;height:324px;overflow:hidden;}
#tips{width:500px;height:300px;text-align:center;line-height:300px;background:rgba(0,0,0,.8);position:absolute;z-index:999;left:15%;top:20%;color:white;display:none}
#close{display:block;position:absolute;right:20px;top:20px;}
</style>
</head>
<body>
<div id='container'>
    <div id='tips'>
        <img src='images/close.png' id='close' />
        <span></span>
    </div>
    <img src='images/arrow.png' id='arrow' />
    <div id='namelist'>
        <ul>
        <li>rocker1</li>
        <li>rocker2</li>
        <li>rocker3</li>
        <li>rocker4</li>
        <li>rocker5</li>
        <li>rocker6</li>
        <li>rocker7</li>
        <li>rocker8</li>
        <li>rocker9</li>
        <li>rocker10</li>
        </ul>
    </div>
</div>
<script src='scripts/jquery-1.8.3.min.js'></script>
<script src='scripts/jquery.rotate.min.js'></script>
<script>
//how to alert ie<8?

var oArrow=document.getElementById('arrow'),
    oTips=document.getElementById('tips'),
    oClose=document.getElementById('close'),
    oSpan=oTips.querySelector('span'),
    oUl=document.querySelector('#namelist ul'),
    oLi=document.querySelector('#namelist li'),
    oLiHeight=oLi.offsetHeight,
    lucknumber=Math.floor((Math.random()*100)%8),
    results=[
    {angle:-90,
     wenzi:'50元喔，恭喜晒'},
    {angle:-45,
     wenzi:'30元喔，恭喜晒'},
    {angle:0,
     wenzi:'0元喔，恭喜晒'},
    {angle:45,
     wenzi:'5元喔，恭喜晒'},
    {angle:90,
     wenzi:'1元喔，恭喜晒'},
    {angle:135,
     wenzi:'10元喔，恭喜晒'},
    {angle:180,
     wenzi:'0元喔，恭喜晒'},
    {angle:225,
     wenzi:'20元喔，恭喜晒'},],
    yourangle=results[lucknumber].angle,
    yourwenzi=results[lucknumber].wenzi,
    oFin=false,count=0,count2=0,oTimer=null;

function once(fn,context){
    var result,count=0;
    return function(){
        if(fn){
            result=fn.apply(context || this , arguments);
            fn=null;
}
        else{
            errormsg='你已经点过啦';
            oSpan.innerHTML=errormsg;
            if(oFin)   oSpan.innerHTML=errormsg+'\n'+yourwenzi;
            oTips.style.display='block';
}
        return result;
}
}

function rotateTo(angle,wenzi){
        console.log('you clicked');
        $(oArrow).rotate({
            angle:0,
            duration:5000,
            animateTo:angle+1440,
            callback:function(){
                oSpan.innerHTML=wenzi;
                oTips.style.display='block';
                oFin=true;
            }
            })
        };

function getData(){
    var script=document.createElement('script');
    script.src='http://www.luck.com/index.php?callback=jsonpResult&count='+count;
    document.body.appendChild(script);
}

function jsonpResult(data){
    var newFragment=document.createDocumentFragment();
    for(var i=0;i<data.length;i++){
        var newLi=document.createElement('li');
        newLi.innerHTML=data[i];
        newFragment.appendChild(newLi);
    };
    oUl.appendChild(newFragment);
    count++;
}

//namelist robin
function nlRobin(){
                /*
                var oSpeed=2;
                count2++;
                var oTarget=-oLiHeight*count2;
             //   console.log(oTarget);
                var animationTimer=setInterval(function(){
                    while(oUl.offsetTop<oTarget){
                    oUl.style.top=oUl.offsetTop-oSpeed+'px';
                        console.log(oUl.offsetTop);
                    }
                    },36);
                setTimeout(function(){
                    animationTimer=null;
                    },1000);
                    */
                oUl.style.top=-oLiHeight*count2+'px';
                if(count2%10==0){  //条件触发jsonp
                    getData();
                }
                count2++;
                if(count2==5) {clearInterval(oTimer);console.log('5 ready')}
}


//中奖算法
function getAward(){
var awards=[0.03,0.1,0.3];
var total=1000;
var startFrom=0;
var lucky=Math.floor((Math.random()*total));
console.log(lucky);

for(var ki=0;ki<awards.length;ki++){
    //选中一个数，如果落在某个区域，就是几等奖。
    console.log(startFrom+'~~~'+(awards[ki]*total+startFrom));
    if(startFrom<lucky && lucky<=(awards[ki]*total+startFrom)){
        if(ki==0){
            var lucky2=Math.random().toFixed(3);
                    }
        return ki+1;
    }
    startFrom=awards[ki]*total+startFrom;
}
}

var defineme=once(function(){
    rotateTo(yourangle,yourwenzi);
});

oArrow.onclick=defineme;

oClose.onclick=function(){
    oTips.style.display='none';
};

oTimer=setInterval(nlRobin,500);
/*
function loadData() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState == 4 && xhttp.status == 200) {
     console.log(xhttp.responseText);
    }
  }
  xhttp.open("post",'http://www.luck.com/index.php', true);
  xhttp.send(count);
}
*/



</script>
</body>
</html>